<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>é™„å½• Aï¼šé…ç½®ä¸è„šæœ¬æ¨¡æ¿ï¼ˆå¯å¤åˆ¶ï¼‰</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é¢å‘ Visionâ€‘Languageâ€‘Actionï¼ˆVLAï¼‰ã€è‡ªåŠ¨é©¾é©¶/å…·èº«ä¸è¯­éŸ³äº¤äº’çš„å¤šæ¨¡æ€å¤§æ¨¡å‹é¢„è®­ç»ƒæ•™ç¨‹ï¼ˆå…¬å¼€ç‰ˆï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[chapter1.md] å‰è¨€ã€èŒƒå›´ä¸è¯»è€…æŒ‡å—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šå…¨å±€æ—¶é—´çº¿ä¸é‡Œç¨‹ç¢‘ï¼ˆW0â€“W26ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸‰ç« ï¼šéœ€æ±‚æ‹†è§£ä¸ç³»ç»Ÿèƒ½åŠ›ç”»åƒï¼ˆVLA / AD / è¯­éŸ³ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å››ç« ï¼šæ•°æ®æ€»ä½“ç­–ç•¥ä¸ 30T token é…é¢ï¼ˆå¤šè¯­å¤šæ¨¡ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äº”ç«  æ•°æ®é‡‡é›† Iï¼šç½‘é¡µæ–‡æœ¬ä¸ä»£ç ï¼ˆåˆè§„ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šæ•°æ®é‡‡é›† IIï¼šéŸ³é¢‘/è¯­éŸ³ï¼ˆæ’­å®¢ã€å…¬å¼€è¯¾ã€è¯­éŸ³æ•°æ®é›†ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç«  æ•°æ®é‡‡é›† IIIï¼šè§†é¢‘ï¼ˆé•¿/çŸ­è§†é¢‘ã€é©¾é©¶/å…·èº«ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[chapter8.md] æ•°æ®é‡‡é›† IVï¼šå›¾åƒ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç«  æ•°æ®é‡‡é›† Vï¼š3Dï¼ˆç¨‹åºåŒ–ä¼˜å…ˆï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬åç« ï¼šæ•°æ®æ²»ç†ä¸è´¨é‡åº¦é‡ï¼ˆè·¨æ¨¡æ€ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç«  è¿‡æ»¤ä¸å»è„ï¼šfastText ä¸å°æ¨¡å‹ç­–ç•¥åº“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šåˆæˆæ•°æ® Iï¼šæ•™ç§‘ä¹¦å¼æ–‡æœ¬/æŒ‡ä»¤ï¼ˆPhi-3 é£æ ¼ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬åä¸‰ç«  åˆæˆæ•°æ® IIï¼šéŸ³é¢‘ä¸è¯­éŸ³</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 14 ç«  åˆæˆæ•°æ® IIIï¼šè§†é¢‘ä¸ VLA è‡ªåšå¼ˆï¼ˆAgentic RL Selfâ€‘Playï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Tokenizer è®¾è®¡ï¼šæ–‡æœ¬/éŸ³é¢‘/è§†é¢‘/å›¾åƒ/3D</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[chapter16.md] ç”Ÿæˆâ€‘ç†è§£ä¸€ä½“æ¶æ„æ²¿é©</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[chapter17.md] æ¨¡å‹æ¶æ„ï¼šQwenâ€‘å¼è‡ªå›å½’ Transformerï¼ˆDense / å…ˆè¿› MoEï¼Œæ—©æœŸèåˆï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[chapter19.md] è®­ç»ƒé…æ–¹ï¼šä» 1B åˆ° 10B çš„ç”Ÿäº§çº§æ–¹æ¡ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[chapter19.md] è®­ç»ƒé…æ–¹ï¼šä» 1B åˆ° 10B çš„ç”Ÿäº§çº§æ–¹æ¡ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 20 ç«  è’¸é¦ä¸æ•™å¸ˆæ¨¡å‹ï¼šGemmaâ€‘å¼ Logits è’¸é¦åŠå¤šæ¨¡æ€çŸ¥è¯†è¿ç§»</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[chapter21.md] å¯¹é½ä¸ä¸­æœŸè®­ç»ƒï¼ˆInstruction/Mid-training/åå¥½ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 22 ç« ï¼šè¯„æµ‹ä¸åŸºå‡†ï¼ˆå¤šæ¨¡/å¤šè¯­/VLA/é©¾é©¶/è¯­éŸ³ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[chapter23.md] æˆæœ¬ã€è¿ç»´ä¸ MLOps</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 24 ç« ï¼šäº¤ä»˜ä¸å¤ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 25 ç« ï¼šå®‰å…¨ã€æ³•å¾‹ä¸åˆè§„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[chapter26.md] é¡¹ç›®ç®¡ç†ä¸äººå‘˜é˜µå‹ï¼šå¤§å‹AIå·¥ç¨‹çš„â€œäº¤å“ä¹æŒ‡æŒ¥æ³•â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">`[chapter27.md]` å¸¸è§é™·é˜±ä¸æ•…éšœæ’æŸ¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter28.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é™„å½• Aï¼šé…ç½®ä¸è„šæœ¬æ¨¡æ¿ï¼ˆå¯å¤åˆ¶ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="appendixA.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é™„å½• Aï¼šé…ç½®ä¸è„šæœ¬æ¨¡æ¿ï¼ˆå¯å¤åˆ¶ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="a">é™„å½• Aï¼šé…ç½®ä¸è„šæœ¬æ¨¡æ¿ï¼ˆå¯å¤åˆ¶ï¼‰</h1>
<p>æœ¬é™„å½•æä¾›äº†æ•´ä¸ªé¢„è®­ç»ƒæµç¨‹ä¸­å…³é”®ç¯èŠ‚çš„å¯å¤åˆ¶ã€å¯ä¿®æ”¹çš„é…ç½®ä¸è„šæœ¬æ¨¡æ¿ã€‚è¿™äº›æ¨¡æ¿æ—¨åœ¨ä½œä¸ºç”Ÿäº§å®è·µçš„èµ·ç‚¹ï¼Œè¯·æ ¹æ®æ‚¨çš„å…·ä½“ç¡¬ä»¶ç¯å¢ƒã€æ•°æ®è·¯å¾„å’Œå®éªŒéœ€æ±‚è¿›è¡Œè°ƒæ•´ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æä¾›â€œå¼€ç®±å³ç”¨â€çš„è“å›¾ï¼Œæœ€å¤§é™åº¦åœ°å‡å°‘ä»ç†è®ºåˆ°å®è·µçš„æ‘©æ“¦ã€‚</p>
<hr />
<h2 id="a1">A.1 æ•°æ®ç®¡é“ï¼šæŠ“å–/ç´¢å¼•/è¿‡æ»¤/å»é‡è„šæœ¬éª¨æ¶</h2>
<p>çœŸå®ä¸–ç•Œçš„æ•°æ®ç®¡é“æ˜¯æ¨¡å—åŒ–ã€å¯è§‚æµ‹ä¸”å®¹é”™çš„ã€‚ä»¥ä¸‹æ¨¡æ¿å±•ç¤ºäº†é’ˆå¯¹ä¸åŒæ¨¡æ€çš„ã€æ›´ç²¾ç»†çš„è„šæœ¬éª¨æ¶å’Œæ ¸å¿ƒé€»è¾‘ä¼ªä»£ç ï¼Œå¹¶å¼•å…¥äº†é…ç½®æ–‡ä»¶ç®¡ç†çš„æœ€ä½³å®è·µã€‚</p>
<h3 id="a11-configenv">A.1.1 é…ç½®æ–‡ä»¶ (<code>config.env</code>)</h3>
<p>å°†æ‰€æœ‰è·¯å¾„å’Œå…³é”®å‚æ•°é›†ä¸­ç®¡ç†ï¼Œä¾¿äºä¸åŒç¯å¢ƒï¼ˆå¼€å‘ã€æš‚å­˜ã€ç”Ÿäº§ï¼‰çš„åˆ‡æ¢ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># --- å…¨å±€è·¯å¾„é…ç½® ---</span>
<span class="na">BASE_RAW_DATA_S3</span><span class="o">=</span><span class="s">&quot;s3://my-company-raw-data&quot;</span>
<span class="na">BASE_PROCESSED_DATA_S3</span><span class="o">=</span><span class="s">&quot;s3://my-company-processed-data&quot;</span>
<span class="na">LOCAL_TEMP_DIR</span><span class="o">=</span><span class="s">&quot;/data/temp_processing&quot;</span>
<span class="na">LOCAL_LOG_DIR</span><span class="o">=</span><span class="s">&quot;/var/logs/data-pipelines&quot;</span>

<span class="c1"># --- æ¨¡å‹ä¸å·¥å…·è·¯å¾„ ---</span>
<span class="na">FASTTEXT_LID_MODEL</span><span class="o">=</span><span class="s">&quot;/models/fasttext/lid.176.bin&quot;</span>
<span class="na">TEXT_QUALITY_MODEL</span><span class="o">=</span><span class="s">&quot;/models/classifiers/text-quality-v1.2&quot;</span>
<span class="na">IMAGE_SAFETY_MODEL</span><span class="o">=</span><span class="s">&quot;/models/classifiers/image-safety-v2.0&quot;</span><span class="w"> </span><span class="c1"># NSFW/æ°´å°/å¾½æ ‡</span>
<span class="na">AUDIO_VAD_MODEL</span><span class="o">=</span><span class="s">&quot;/models/vad/silero-vad.onnx&quot;</span>
<span class="na">ASR_WHISPER_MODEL</span><span class="o">=</span><span class="s">&quot;large-v3&quot;</span>

<span class="c1"># --- ç®¡é“å‚æ•° ---</span>
<span class="na">DEFAULT_NUM_WORKERS</span><span class="o">=</span><span class="s">256</span>
<span class="na">WEB_SCRAPE_USER_AGENT</span><span class="o">=</span><span class="s">&quot;MyCompanyResearchCrawler/1.0 (+http://my.company/bot.html)&quot;</span>
<span class="na">YOUTUBE_API_KEY</span><span class="o">=</span><span class="s">&quot;AIzaSyXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="w"> </span><span class="c1"># ä¸¥æ ¼ä½¿ç”¨å®˜æ–¹API</span>

<span class="c1"># --- è§†é¢‘å¤„ç†æ ‡å‡† ---</span>
<span class="na">VIDEO_TARGET_RESOLUTION</span><span class="o">=</span><span class="s">&quot;854x480&quot;</span><span class="w"> </span><span class="c1"># æ¥è¿‘ 480p, 16:9</span>
<span class="na">VIDEO_TARGET_FPS</span><span class="o">=</span><span class="s">12</span>
<span class="na">VIDEO_TARGET_CRF</span><span class="o">=</span><span class="s">28</span><span class="w"> </span><span class="c1"># H.264 å‹ç¼©è´¨é‡, æ•°å€¼è¶Šé«˜å‹ç¼©ç‡é«˜</span>
</code></pre></div>

<h3 id="a12-run_text_pipelinesh">A.1.2 æ–‡æœ¬å¤„ç†ç®¡é“ (<code>run_text_pipeline.sh</code>)</h3>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nb">set</span><span class="w"> </span>-e
<span class="nb">source</span><span class="w"> </span>config.env<span class="w"> </span><span class="c1"># åŠ è½½é…ç½®</span>

<span class="c1"># --- è¾“å…¥å‚æ•° ---</span>
<span class="nv">SOURCE_NAME</span><span class="o">=</span><span class="nv">$1</span><span class="w"> </span><span class="c1"># e.g., &quot;common_crawl_2023_10&quot;</span>
<span class="nv">INPUT_S3_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASE</span><span class="se">\_</span><span class="nv">RAW</span><span class="se">\_</span><span class="nv">DATA</span><span class="se">\_</span><span class="nv">S3</span><span class="si">}</span><span class="s2">/text/</span><span class="si">${</span><span class="nv">SOURCE_NAME</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span>
<span class="nv">OUTPUT_S3_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASE</span><span class="se">\_</span><span class="nv">PROCESSED</span><span class="se">\_</span><span class="nv">DATA</span><span class="se">\_</span><span class="nv">S3</span><span class="si">}</span><span class="s2">/text/</span><span class="si">${</span><span class="nv">SOURCE_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">PIPELINE_LOG_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">LOCAL</span><span class="se">\_</span><span class="nv">LOG</span><span class="se">\_</span><span class="nv">DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SOURCE_NAME</span><span class="si">}</span><span class="s2">_</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="s2">.log&quot;</span>

<span class="nb">exec</span><span class="w"> </span>&gt;<span class="w"> </span>&gt;<span class="o">(</span>tee<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PIPELINE_LOG_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">)</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;--- [</span><span class="k">$(</span>date<span class="k">)</span><span class="s2">] STAGE 1: æ‹‰å–ä¸è§£å‹ ---&quot;</span>
aws<span class="w"> </span>s3<span class="w"> </span>cp<span class="w"> </span><span class="si">${</span><span class="nv">INPUT</span><span class="se">\_</span><span class="nv">S3</span><span class="se">\_</span><span class="nv">PATH</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_TEMP_DIR</span><span class="si">}</span>/
<span class="c1"># ... è§£å‹é€»è¾‘ ...</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;--- [</span><span class="k">$(</span>date<span class="k">)</span><span class="s2">] STAGE 2: ç²—ç­›ä¸æ ¼å¼åŒ– (å¹¶è¡Œ) ---&quot;</span>
<span class="c1"># process_warc.py: æå–ä¸»å†…å®¹, HTMLæ ‡ç­¾æ¸…æ´—, fastTextè¯­è¨€è¯†åˆ«</span>
find<span class="w"> </span><span class="si">${</span><span class="nv">LOCAL</span><span class="se">\_</span><span class="nv">TEMP</span><span class="se">\_</span><span class="nv">DIR</span><span class="si">}</span>/raw<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;\*.warc.gz&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>parallel<span class="w"> </span>-j<span class="w"> </span><span class="si">${</span><span class="nv">DEFAULT_NUM_WORKERS</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>python<span class="w"> </span>scripts/process_warc.py<span class="w"> </span>--input<span class="w"> </span><span class="o">{}</span><span class="w"> </span>...

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;--- [</span><span class="k">$(</span>date<span class="k">)</span><span class="s2">] STAGE 3: ç²¾ç»†è¿‡æ»¤ä¸è´¨é‡æ‰“åˆ† (å¹¶è¡Œ) ---&quot;</span>
<span class="c1"># filter_quality.py: ä½¿ç”¨å°æ¨¡å‹è¿›è¡Œæ¯’æ€§/å¹¿å‘Š/ä½è´¨åˆ†ç±», PIIæ£€æµ‹</span>
find<span class="w"> </span><span class="si">${</span><span class="nv">LOCAL</span><span class="se">\_</span><span class="nv">TEMP</span><span class="se">\_</span><span class="nv">DIR</span><span class="si">}</span>/jsonl<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;\*.jsonl&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>parallel<span class="w"> </span>-j<span class="w"> </span><span class="si">${</span><span class="nv">DEFAULT_NUM_WORKERS</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>python<span class="w"> </span>scripts/filter_quality.py<span class="w"> </span>--input<span class="w"> </span><span class="o">{}</span><span class="w"> </span>--quality_model<span class="w"> </span><span class="si">${</span><span class="nv">TEXT_QUALITY_MODEL</span><span class="si">}</span><span class="w"> </span>...

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;--- [</span><span class="k">$(</span>date<span class="k">)</span><span class="s2">] STAGE 4: å…¨å±€å»é‡ (Spark/Ray) ---&quot;</span>
<span class="c1"># å®é™…ç”Ÿäº§ä¸­, è¿™ä¸€æ­¥é€šå¸¸åœ¨åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ä¸­å®Œæˆ</span>
spark-submit<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--master<span class="w"> </span>yarn<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--num-executors<span class="w"> </span><span class="m">512</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>jobs/deduplicate_text.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--input_path<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">LOCAL_TEMP_DIR</span><span class="si">}</span><span class="s2">/filtered/&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output_path<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">LOCAL_TEMP_DIR</span><span class="si">}</span><span class="s2">/deduplicated/&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--dedup_method<span class="w"> </span><span class="s2">&quot;minhash_lsh&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;--- [</span><span class="k">$(</span>date<span class="k">)</span><span class="s2">] STAGE 5: WebDataset æ‰“åŒ…ä¸ä¸Šä¼  ---&quot;</span>
webdataset<span class="w"> </span>create<span class="w"> </span>--input<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">LOCAL_TEMP_DIR</span><span class="si">}</span><span class="s2">/deduplicated/&quot;</span><span class="w"> </span>...
aws<span class="w"> </span>s3<span class="w"> </span>sync<span class="w"> </span><span class="si">${</span><span class="nv">LOCAL</span><span class="se">\_</span><span class="nv">TEMP</span><span class="se">\_</span><span class="nv">DIR</span><span class="si">}</span>/webdataset/<span class="w"> </span><span class="si">${</span><span class="nv">OUTPUT_S3_PATH</span><span class="si">}</span>/

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;--- [</span><span class="k">$(</span>date<span class="k">)</span><span class="s2">] ç®¡é“ </span><span class="si">${</span><span class="nv">SOURCE_NAME</span><span class="si">}</span><span class="s2"> æ‰§è¡Œå®Œæ¯• ---&quot;</span>
</code></pre></div>

<h3 id="a13-process_videopy">A.1.3 è§†é¢‘å¤„ç†ç®¡é“æ ¸å¿ƒé€»è¾‘ (<code>process_video.py</code> ä¼ªä»£ç )</h3>
<p>è§†é¢‘å¤„ç†æ¶‰åŠå¤æ‚çš„æ—¶åºå’Œå¤šæµæ“ä½œï¼ŒFFmpeg æ˜¯æ ¸å¿ƒå·¥å…·ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">ffmpeg</span>
<span class="kn">import</span> <span class="nn">whisper</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">process_single_video</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
    <span class="c1"># 1. è§„æ ¼æ ‡å‡†åŒ–: é™é‡‡æ ·è°ƒæ•´åˆ†è¾¨ç‡ã€é‡æ–°ç¼–ç </span>
    <span class="p">(</span>
        <span class="n">ffmpeg</span>
        <span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;fps&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">VIDEO_TARGET_FPS</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">VIDEO_TARGET_RESOLUTION</span><span class="p">)</span>
        <span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/processed.mp4&quot;</span><span class="p">,</span> <span class="n">vcodec</span><span class="o">=</span><span class="s1">&#39;libx264&#39;</span><span class="p">,</span> <span class="n">crf</span><span class="o">=</span><span class="n">VIDEO_TARGET_CRF</span><span class="p">,</span> <span class="n">preset</span><span class="o">=</span><span class="s1">&#39;fast&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">capture_stdout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_stderr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># 2. æå–éŸ³é¢‘</span>
    <span class="n">ffmpeg</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/processed.mp4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/audio.wav&quot;</span><span class="p">,</span> <span class="n">acodec</span><span class="o">=</span><span class="s1">&#39;pcm_s16le&#39;</span><span class="p">,</span> <span class="n">ac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ar</span><span class="o">=</span><span class="s1">&#39;16000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># 3. VAD (è¯­éŸ³æ´»åŠ¨æ£€æµ‹) åˆ‡åˆ†</span>
    <span class="c1"># vad_segments = apply_vad(f&quot;{output_dir}/audio.wav&quot;, model=AUDIO_VAD_MODEL)</span>

    <span class="c1"># 4. ASR è½¬å†™ (ä½¿ç”¨ Whisper è·å–å¸¦æ—¶é—´æˆ³çš„æ–‡æœ¬)</span>
    <span class="n">asr_model</span> <span class="o">=</span> <span class="n">whisper</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">ASR_WHISPER_MODEL</span><span class="p">)</span>
    <span class="n">asr_result</span> <span class="o">=</span> <span class="n">asr_model</span><span class="o">.</span><span class="n">transcribe</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/audio.wav&quot;</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="s1">&#39;zh&#39;</span><span class="p">)</span> <span class="c1"># æŒ‡å®šè¯­ç§</span>

    <span class="c1"># 5. å¸§æå–ä¸è¿‡æ»¤</span>
    <span class="c1"># - æå–å…³é”®å¸§ (I-frames) æˆ–æŒ‰å›ºå®šé—´éš”é‡‡æ ·</span>
    <span class="c1"># - ä½¿ç”¨å›¾åƒå®‰å…¨æ¨¡å‹è¿‡æ»¤æ¯ä¸€å¸§</span>
    <span class="c1"># safe_frame_indices = filter_frames(video_path, model=IMAGE_SAFETY_MODEL)</span>

    <span class="c1"># 6. ç”Ÿæˆå…ƒæ•°æ®æ–‡ä»¶</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;original_path&#39;</span><span class="p">:</span> <span class="n">video_path</span><span class="p">,</span>
        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">ffmpeg</span><span class="o">.</span><span class="n">probe</span><span class="p">(</span><span class="n">video_path</span><span class="p">)[</span><span class="s1">&#39;format&#39;</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">],</span>
        <span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
        <span class="s1">&#39;asr_transcript&#39;</span><span class="p">:</span> <span class="n">asr_result</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span>
        <span class="s1">&#39;asr_segments&#39;</span><span class="p">:</span> <span class="n">asr_result</span><span class="p">[</span><span class="s1">&#39;segments&#39;</span><span class="p">],</span> <span class="c1"># å¸¦æ—¶é—´æˆ³</span>
        <span class="c1"># &#39;safe_frame_indices&#39;: safe_frame_indices,</span>
        <span class="c1"># &#39;vad_segments&#39;: vad_segments</span>
    <span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/metadata.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># æœ€ç»ˆæ‰“åŒ…æ—¶, ä¼šå°† processed.mp4 å’Œ metadata.json ä¸€èµ·æ”¾å…¥ tar åŒ…</span>
</code></pre></div>

<hr />
<h2 id="a2-tokenizer">A.2 Tokenizer è®­ç»ƒä¸æ‰©è¡¨é…ç½®</h2>
<h3 id="a21-train_tokenizerpy">A.2.1 è®­ç»ƒè„šæœ¬ (<code>train_tokenizer.py</code>)</h3>
<p>å±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code>tokenizers</code> åº“ä»åŸå§‹æ–‡æœ¬æ–‡ä»¶è®­ç»ƒä¸€ä¸ª BPE tokenizerã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">tokenizers</span> <span class="kn">import</span> <span class="n">Tokenizer</span>
<span class="kn">from</span> <span class="nn">tokenizers.models</span> <span class="kn">import</span> <span class="n">BPE</span>
<span class="kn">from</span> <span class="nn">tokenizers.trainers</span> <span class="kn">import</span> <span class="n">BpeTrainer</span>
<span class="kn">from</span> <span class="nn">tokenizers.pre_tokenizers</span> <span class="kn">import</span> <span class="n">ByteLevel</span>
<span class="kn">from</span> <span class="nn">tokenizers.normalizers</span> <span class="kn">import</span> <span class="n">NFC</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Lowercase</span>
<span class="kn">from</span> <span class="nn">tokenizers.decoders</span> <span class="kn">import</span> <span class="n">ByteLevel</span> <span class="k">as</span> <span class="n">ByteLevelDecoder</span>

<span class="c1"># 1. å®šä¹‰è¯è¡¨å’Œç‰¹æ®Š Tokens</span>
<span class="n">VOCAB_SIZE</span> <span class="o">=</span> <span class="mi">151936</span> <span class="c1"># å‚è€ƒ Qwen-1.5-14B</span>
<span class="n">SPECIAL_TOKENS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># --- åŸºç¡€æ§åˆ¶ Tokens ---</span>
    <span class="s2">&quot;&lt;|endoftext|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;|im_start|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;|im_end|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;[PAD]&quot;</span><span class="p">,</span> <span class="s2">&quot;[UNK]&quot;</span><span class="p">,</span>
    <span class="c1"># --- å¤šæ¨¡æ€ä¸ VLA ä¸“ç”¨ Tokens (æ–°å¢) ---</span>
    <span class="s2">&quot;&lt;|vision_start|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;|vision_end|&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|audio_start|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;|audio_end|&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|3d_start|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;|3d_end|&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|action_start|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;|action_end|&gt;&quot;</span><span class="p">,</span>
    <span class="c1"># --- é©¾é©¶åœºæ™¯: ç›¸æœºä½å§¿ ---</span>
    <span class="s2">&quot;&lt;|cam_front|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;|cam_front_left|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;|cam_front_right|&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;&lt;|cam_back|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;|cam_left_repeater|&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;|cam_right_repeater|&gt;&quot;</span><span class="p">,</span>
    <span class="c1"># --- IPA ä¸ ç¨‹åºåŒ– 3D Tokens (é«˜é¢‘éƒ¨åˆ†) ---</span>
    <span class="s2">&quot;É™&quot;</span><span class="p">,</span> <span class="s2">&quot;Êƒ&quot;</span><span class="p">,</span> <span class="s2">&quot;Å‹&quot;</span><span class="p">,</span> <span class="s2">&quot;Î¸&quot;</span><span class="p">,</span> <span class="s2">&quot;Ã°&quot;</span><span class="p">,</span> <span class="c1"># IPA</span>
    <span class="s2">&quot;bpy.ops.mesh&quot;</span><span class="p">,</span> <span class="s2">&quot;location=&quot;</span><span class="p">,</span> <span class="s2">&quot;rotation_euler=&quot;</span><span class="p">,</span> <span class="s2">&quot;scale=&quot;</span><span class="p">,</span> <span class="c1"># Blender</span>
<span class="p">]</span>


<span class="c1"># 2. åˆå§‹åŒ– Tokenizer</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="n">BPE</span><span class="p">(</span><span class="n">unk_token</span><span class="o">=</span><span class="s2">&quot;[UNK]&quot;</span><span class="p">))</span>
<span class="n">tokenizer</span><span class="o">.</span><span class="n">normalizer</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">([</span><span class="n">NFC</span><span class="p">(),</span> <span class="n">Lowercase</span><span class="p">()])</span> <span class="c1"># å¯é€‰</span>
<span class="n">tokenizer</span><span class="o">.</span><span class="n">pre_tokenizer</span> <span class="o">=</span> <span class="n">ByteLevel</span><span class="p">(</span><span class="n">add_prefix_space</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tokenizer</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">ByteLevelDecoder</span><span class="p">()</span>

<span class="c1"># 3. é…ç½®è®­ç»ƒå™¨</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">BpeTrainer</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="n">VOCAB_SIZE</span><span class="p">,</span> <span class="n">special_tokens</span><span class="o">=</span><span class="n">SPECIAL_TOKENS</span><span class="p">,</span> <span class="n">min_frequency</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># 4. è·å–è®­ç»ƒæ–‡ä»¶åˆ—è¡¨</span>
<span class="c1"># å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«å¤šç§è¯­è¨€å’Œä»£ç çš„æ··åˆè¯­æ–™</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;/path/to/text/corpus/*.txt&quot;</span><span class="p">)</span>

<span class="c1"># 5. å¯åŠ¨è®­ç»ƒ</span>
<span class="n">tokenizer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">trainer</span><span class="p">)</span>

<span class="c1"># 6. ä¿å­˜ Tokenizer</span>
<span class="n">tokenizer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;vla_multimodal_tokenizer.json&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tokenizer trained with vocab size: </span><span class="si">{</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">get_vocab_size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 7. æµ‹è¯•</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ä½ å¥½ä¸–ç•Œ, Hello world! Let&#39;s test IPA: /nÉªËˆhaÊŠ/ and bpy.ops.mesh!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Encoded IDs:&quot;</span><span class="p">,</span> <span class="n">encoded</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Decoded text:&quot;</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoded</span><span class="o">.</span><span class="n">ids</span><span class="p">))</span>
</code></pre></div>

<h3 id="a22-3d-tokenization">A.2.2 3D Tokenization ç­–ç•¥å¯¹æ¯”</h3>
<p>| ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |</p>
<table>
<thead>
<tr>
<th style="text-align: left;">ç­–ç•¥</th>
<th style="text-align: left;">ä¼˜ç‚¹</th>
<th style="text-align: left;">ç¼ºç‚¹</th>
<th style="text-align: left;">é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>ç¨‹åºåŒ–è„šæœ¬ (Blender/CAD)</strong></td>
<td style="text-align: left;"><strong>æé«˜å‹ç¼©ç‡</strong>ï¼›<strong>è¯­ä¹‰ä¸°å¯Œ</strong>ï¼Œå¯ç¼–è¾‘ï¼Œå¯æ¨ç†ï¼›ç‰ˆæœ¬åŒ–å‹å¥½</td>
<td style="text-align: left;">éœ€è¦æ¨¡å‹ç†è§£è¯­æ³•å’Œæ‰§è¡Œé€»è¾‘ï¼›æ•°æ®æºè¾ƒå°‘</td>
<td style="text-align: left;">éœ€è¦ç”Ÿæˆå¯æ‰§è¡Œ/å¯è¾‘ 3D å†…å®¹çš„ä»»åŠ¡</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ–‡æœ¬ç»“æ„åŒ– (X3D/XML)</strong></td>
<td style="text-align: left;">ç»“æ„æ¸…æ™°ï¼Œå±‚çº§å…³ç³»æ˜ç¡®ï¼›æ¯”ç½‘æ ¼æ–‡ä»¶å¯è¯»æ€§é«˜</td>
<td style="text-align: left;">å†—ä½™åº¦è¾ƒé«˜ï¼›å¯¹å¤æ‚æ‹“æ‰‘æè¿°èƒ½åŠ›æœ‰é™</td>
<td style="text-align: left;">åœºæ™¯æè¿°ã€ç®€å•å‡ ä½•ä½“ç»„åˆ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ä¼ ç»Ÿç½‘æ ¼æ ¼å¼ (.obj)</strong></td>
<td style="text-align: left;">ç®€å•ç›´æ¥ï¼Œå…¼å®¹æ€§å¥½ï¼›æ•°æ®æºå¹¿æ³›</td>
<td style="text-align: left;"><strong>ä¿¡æ¯å¯†åº¦ä½</strong>ï¼Œå¤§é‡é‡å¤çš„ <code>v</code>, <code>vt</code>, <code>f</code>ï¼›æ— è¯­ä¹‰ä¿¡æ¯</td>
<td style="text-align: left;">ä½œä¸ºå…œåº•æ–¹æ¡ˆï¼Œå¤„ç†æ— æ³•ç¨‹åºåŒ–çš„å­˜é‡æ•°æ®</td>
</tr>
</tbody>
</table>
<p><strong>ç¨‹åºåŒ–è„šæœ¬ Tokenization ç¤ºä¾‹:</strong></p>
<p>åŸå§‹ Blender Python ä»£ç :
<code>bpy.ops.mesh.primitive_cube_add(size=2, location=(1, 2, 3))</code></p>
<p>Tokenized åºåˆ— (ä½¿ç”¨æ‰©å……è¯è¡¨çš„ tokenizer):
<code>[&lt;bpy.ops.mesh&gt;, .primitive_cube_add, (, size, =, 2, ,, &lt;location=&gt;, (, 1, ,, 2, ,, 3, ), )]</code>
æ³¨æ„ <code>location=</code> è¢«åˆå¹¶ä¸ºä¸€ä¸ª tokenï¼Œè¿™æ¯”é€å­—ç¬¦ tokenization é«˜æ•ˆå¾—å¤šã€‚</p>
<hr />
<h2 id="a3-megatron">A.3 Megatron å¯åŠ¨å‚æ•°çŸ©é˜µ</h2>
<h3 id="a31-1b-dense-run_pretrain_1b_densesh">A.3.1 1B Dense æ¨¡å‹å¯åŠ¨è„šæœ¬ (<code>run_pretrain_1b_dense.sh</code>)</h3>
<p>æ­¤è„šæœ¬ä¸ºå¿«é€Ÿè¿­ä»£å’ŒéªŒè¯ç«¯åˆ°ç«¯æµç¨‹çš„åŸºçº¿ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># é€‚ç”¨äº 4-8 ä¸ªèŠ‚ç‚¹ (32-64 GPUs)</span>

<span class="c1"># --- é›†ç¾¤ä¸ç¯å¢ƒ ---</span>
<span class="nv">NNODES</span><span class="o">=</span><span class="m">4</span>
<span class="nv">GPUS_PER_NODE</span><span class="o">=</span><span class="m">8</span>
<span class="nv">WORLD_SIZE</span><span class="o">=</span><span class="k">$((</span><span class="nv">$GPUS_PER_NODE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">$NNODES</span><span class="k">))</span>

<span class="c1"># --- è·¯å¾„é…ç½® ---</span>
<span class="nv">DATA_PATH</span><span class="o">=</span><span class="s2">&quot;/data/blended_multimodal_data_small/my_dataset_idx&quot;</span>
<span class="nv">CHECKPOINT_PATH</span><span class="o">=</span><span class="s2">&quot;/checkpoints/vla-1b-dense&quot;</span>
<span class="nv">TOKENIZER_PATH</span><span class="o">=</span><span class="s2">&quot;/models/tokenizer_vla&quot;</span>

<span class="c1"># --- Megatron-LM åˆ†å¸ƒå¼å‚æ•° ---</span>
<span class="nv">TP</span><span class="o">=</span><span class="m">2</span><span class="w">  </span><span class="c1"># èŠ‚ç‚¹å†… NVLink</span>
<span class="nv">PP</span><span class="o">=</span><span class="m">4</span><span class="w">  </span><span class="c1"># è·¨èŠ‚ç‚¹</span>
<span class="c1"># DP = 32 / (2 * 4) = 4</span>

<span class="c1"># --- 1B Dense æ¨¡å‹ç»“æ„ ---</span>
<span class="nv">NUM_LAYERS</span><span class="o">=</span><span class="m">24</span>
<span class="nv">HIDDEN_SIZE</span><span class="o">=</span><span class="m">2048</span>
<span class="nv">FFN_HIDDEN_SIZE</span><span class="o">=</span><span class="m">5632</span><span class="w"> </span><span class="c1"># SwiGLU FFN é€šå¸¸æ˜¯ 2/3 * 4 * H</span>
<span class="nv">NUM_ATTN_HEADS</span><span class="o">=</span><span class="m">16</span>
<span class="nv">SEQ_LENGTH</span><span class="o">=</span><span class="m">4096</span>

<span class="c1"># --- è®­ç»ƒè¶…å‚æ•° ---</span>
<span class="nv">MICRO_BATCH_SIZE</span><span class="o">=</span><span class="m">4</span>
<span class="nv">GLOBAL_BATCH_SIZE</span><span class="o">=</span><span class="m">1024</span><span class="w"> </span><span class="c1"># 4 * 4 * 64 = 1024</span>
<span class="c1"># Grad Accum Steps = 1024 / (4 * 4) = 64</span>
<span class="nv">TRAIN_TOKENS</span><span class="o">=</span><span class="m">1000000000000</span><span class="w"> </span><span class="c1"># 1T tokens (ç”¨äºåŸºçº¿)</span>
<span class="nv">LR</span><span class="o">=</span>3e-4
<span class="nv">MIN_LR</span><span class="o">=</span>3e-5
<span class="nv">LR_DECAY_STYLE</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span>
<span class="nv">LR_WARMUP_TOKENS</span><span class="o">=</span><span class="m">375000000</span><span class="w"> </span><span class="c1"># 375B</span>
<span class="nv">WEIGHT_DECAY</span><span class="o">=</span><span class="m">0</span>.1
<span class="nv">GRAD_CLIP</span><span class="o">=</span><span class="m">1</span>.0

<span class="c1"># --- ç²¾åº¦é…ç½® ---</span>
<span class="nv">FP8_FORMAT</span><span class="o">=</span><span class="s2">&quot;hybrid&quot;</span>
<span class="nv">USE_FP8</span><span class="o">=</span><span class="s2">&quot;--fp8-hybrid&quot;</span>

<span class="c1"># --- æ„å»ºå¯åŠ¨å‘½ä»¤ ---</span>
torchrun<span class="w"> </span>...<span class="w"> </span>pretrain_gpt.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--tensor-model-parallel-size<span class="w"> </span><span class="nv">$TP</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--pipeline-model-parallel-size<span class="w"> </span><span class="nv">$PP</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="se">\</span>
<span class="w">  </span>--num-layers<span class="w"> </span><span class="nv">$NUM_LAYERS</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--hidden-size<span class="w"> </span><span class="nv">$HIDDEN_SIZE</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--ffn-hidden-size<span class="w"> </span><span class="nv">$FFN_HIDDEN_SIZE</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--num-attention-heads<span class="w"> </span><span class="nv">$NUM_ATTN_HEADS</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seq-length<span class="w"> </span><span class="nv">$SEQ_LENGTH</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--swiglu<span class="w"> </span>--use-rotary-position-embeddings<span class="w"> </span>--normalization<span class="w"> </span>RMSNorm<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="se">\</span>
<span class="w">  </span>--micro-batch-size<span class="w"> </span><span class="nv">$MICRO_BATCH_SIZE</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--global-batch-size<span class="w"> </span><span class="nv">$GLOBAL_BATCH_SIZE</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--train-tokens<span class="w"> </span><span class="nv">$TRAIN_TOKENS</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="se">\</span>
<span class="w">  </span><span class="nv">$USE_FP8</span><span class="w"> </span>--bf16<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--optimizer<span class="w"> </span>adam<span class="w"> </span>--adam-beta1<span class="w"> </span><span class="m">0</span>.9<span class="w"> </span>--adam-beta2<span class="w"> </span><span class="m">0</span>.95<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># ... å…¶ä»–å‚æ•°ä¸ 10B è„šæœ¬ç±»ä¼¼ ...</span>
</code></pre></div>

<h3 id="a32-10b-moe-run_pretrain_10b_moesh">A.3.2 10B MoE æ¨¡å‹å¯åŠ¨è„šæœ¬ (<code>run_pretrain_10b_moe.sh</code>)</h3>
<p>æ­¤è„šæœ¬ä¸ºç”Ÿäº§çº§è®­ç»ƒæ–¹æ¡ˆï¼Œç»†èŠ‚æ›´ä¸°å¯Œã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># --- é›†ç¾¤ä¸ç¯å¢ƒé…ç½® ---</span>
<span class="nv">NNODES</span><span class="o">=</span><span class="m">32</span>
<span class="nv">GPUS_PER_NODE</span><span class="o">=</span><span class="m">8</span>
<span class="nv">WORLD_SIZE</span><span class="o">=</span><span class="k">$((</span><span class="nv">$GPUS_PER_NODE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">$NNODES</span><span class="k">))</span><span class="w"> </span><span class="c1"># 256</span>
<span class="nv">MASTER_ADDR</span><span class="o">=</span><span class="k">$(</span>scontrol<span class="w"> </span>show<span class="w"> </span>hostnames<span class="w"> </span><span class="nv">$SLURM_JOB_NODELIST</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="k">)</span>
<span class="nv">MASTER_PORT</span><span class="o">=</span><span class="m">6000</span>

<span class="c1"># --- æ•°æ®ä¸æ¨¡å‹è·¯å¾„ ---</span>
<span class="nv">DATA_PATH</span><span class="o">=</span><span class="s2">&quot;/data/blended_multimodal_data/my_dataset_idx&quot;</span>
<span class="nv">CHECKPOINT_PATH</span><span class="o">=</span><span class="s2">&quot;/checkpoints/vla-10b-moe&quot;</span>
<span class="nv">TOKENIZER_PATH</span><span class="o">=</span><span class="s2">&quot;/models/tokenizer_vla/tokenizer.model&quot;</span>
<span class="nv">WANDB_PROJECT</span><span class="o">=</span><span class="s2">&quot;vla-10b-pretrain-run&quot;</span>

<span class="c1"># --- Megatron-LM åˆ†å¸ƒå¼å‚æ•° ---</span>
<span class="nv">TP</span><span class="o">=</span><span class="m">4</span><span class="w">  </span><span class="c1"># èŠ‚ç‚¹å†… 4-way Tensor Parallel</span>
<span class="nv">PP</span><span class="o">=</span><span class="m">8</span><span class="w">  </span><span class="c1"># è·¨ 8 ä¸ªèŠ‚ç‚¹ Pipeline Parallel</span>
<span class="c1"># DP = 256 / (4 * 8) = 8</span>

<span class="c1"># --- 10B MoE æ¨¡å‹ç»“æ„å‚æ•° ---</span>
<span class="nv">NUM_LAYERS</span><span class="o">=</span><span class="m">40</span>
<span class="nv">HIDDEN_SIZE</span><span class="o">=</span><span class="m">4096</span>
<span class="nv">FFN_HIDDEN_SIZE</span><span class="o">=</span><span class="m">14336</span>
<span class="nv">NUM_ATTN_HEADS</span><span class="o">=</span><span class="m">32</span>
<span class="nv">SEQ_LENGTH</span><span class="o">=</span><span class="m">4096</span>

<span class="c1"># --- MoE ç›¸å…³å‚æ•° ---</span>
<span class="nv">NUM_EXPERTS</span><span class="o">=</span><span class="m">64</span>
<span class="nv">EXPERT_PARALLEL_SIZE</span><span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="c1"># å°†64ä¸ªä¸“å®¶åˆ†å¸ƒåœ¨4ä¸ªGPUä¸Š, æ¯ä¸ªGPU 16ä¸ª</span>
<span class="nv">MOE_ROUTED_TOKENS</span><span class="o">=</span><span class="m">4</span><span class="w">    </span><span class="c1"># Top-k</span>
<span class="nv">MOE_CAPACITY_FACTOR</span><span class="o">=</span><span class="m">1</span>.25<span class="w"> </span><span class="c1"># ä¸“å®¶å®¹é‡å› å­, 1.0è¡¨ç¤ºåˆšå¥½, &gt;1.0æä¾›å†—ä½™</span>
<span class="nv">MOE_LOSS_COEFF</span><span class="o">=</span><span class="m">0</span>.01<span class="w">      </span><span class="c1"># è´Ÿè½½å‡è¡¡æŸå¤±çš„æƒé‡</span>
<span class="nv">MOE_MIN_CAPACITY</span><span class="o">=</span><span class="m">4</span><span class="w">       </span><span class="c1"># æ¯ä¸ªä¸“å®¶çš„æœ€å°å®¹é‡</span>

<span class="c1"># --- è®­ç»ƒè¶…å‚æ•° ---</span>
<span class="nv">MICRO_BATCH_SIZE</span><span class="o">=</span><span class="m">1</span>
<span class="nv">GLOBAL_BATCH_SIZE</span><span class="o">=</span><span class="m">2048</span>
<span class="nv">TRAIN_TOKENS</span><span class="o">=</span><span class="m">10000000000000</span><span class="w"> </span><span class="c1"># 10T tokens</span>
<span class="nv">LR</span><span class="o">=</span><span class="m">1</span>.0e-4
<span class="nv">MIN_LR</span><span class="o">=</span><span class="m">1</span>.0e-5
<span class="nv">LR_DECAY_STYLE</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span>
<span class="nv">LR_WARMUP_TOKENS</span><span class="o">=</span><span class="m">375000000</span><span class="w"> </span><span class="c1"># 375B</span>
<span class="nv">WEIGHT_DECAY</span><span class="o">=</span><span class="m">0</span>.1
<span class="nv">GRAD_CLIP</span><span class="o">=</span><span class="m">1</span>.0

<span class="c1"># --- ç²¾åº¦é…ç½® (TransformerEngine) ---</span>
<span class="nv">FP8_FORMAT</span><span class="o">=</span><span class="s2">&quot;hybrid&quot;</span>
<span class="nv">USE_FP8</span><span class="o">=</span><span class="s2">&quot;--fp8-hybrid&quot;</span>

<span class="c1"># --- æ„å»ºå¯åŠ¨å‘½ä»¤ ---</span>
<span class="c1"># ä½¿ç”¨ torchrun æˆ– srun for Slurm</span>
srun<span class="w"> </span>--jobid<span class="w"> </span><span class="nv">$SLURM_JOB_ID</span><span class="w"> </span>torchrun<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--nnodes<span class="w"> </span><span class="nv">$NNODES</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--nproc_per_node<span class="w"> </span><span class="nv">$GPUS_PER_NODE</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--rdzv_id<span class="w"> </span><span class="nv">$SLURM_JOB_ID</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--rdzv_backend<span class="w"> </span>c10d<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--rdzv_endpoint<span class="w"> </span><span class="nv">$MASTER</span><span class="se">\_</span>ADDR:<span class="nv">$MASTER_PORT</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>pretrain_gpt.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># --- åˆ†å¸ƒå¼é…ç½® ---</span>
<span class="w">  </span>--tensor-model-parallel-size<span class="w"> </span><span class="nv">$TP</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--pipeline-model-parallel-size<span class="w"> </span><span class="nv">$PP</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--expert-model-parallel-size<span class="w"> </span><span class="nv">$EXPERT_PARALLEL_SIZE</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--distributed-backend<span class="w"> </span>nccl<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># --- MoE é…ç½® ---</span>
<span class="w">  </span>--num-experts<span class="w"> </span><span class="nv">$NUM_EXPERTS</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--moe-top-k<span class="w"> </span><span class="nv">$MOE_ROUTED_TOKENS</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--moe-capacity-factor<span class="w"> </span><span class="nv">$MOE_CAPACITY_FACTOR</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--moe-loss-coeff<span class="w"> </span><span class="nv">$MOE_LOSS_COEFF</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--moe-min-capacity<span class="w"> </span><span class="nv">$MOE_MIN_CAPACITY</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># --- æ¨¡å‹æ¶æ„ ---</span>
<span class="w">  </span>--num-layers<span class="w"> </span><span class="nv">$NUM_LAYERS</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--hidden-size<span class="w"> </span><span class="nv">$HIDDEN_SIZE</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--ffn-hidden-size<span class="w"> </span><span class="nv">$FFN_HIDDEN_SIZE</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--num-attention-heads<span class="w"> </span><span class="nv">$NUM_ATTN_HEADS</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seq-length<span class="w"> </span><span class="nv">$SEQ_LENGTH</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--max-position-embeddings<span class="w"> </span><span class="nv">$SEQ_LENGTH</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--swiglu<span class="w"> </span>--use-rotary-position-embeddings<span class="w"> </span>--normalization<span class="w"> </span>RMSNorm<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># --- è®­ç»ƒå‚æ•° ---</span>
<span class="w">  </span>--micro-batch-size<span class="w"> </span><span class="nv">$MICRO_BATCH_SIZE</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--global-batch-size<span class="w"> </span><span class="nv">$GLOBAL_BATCH_SIZE</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--train-tokens<span class="w"> </span><span class="nv">$TRAIN_TOKENS</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># --- ç²¾åº¦ä¸ä¼˜åŒ–å™¨ ---</span>
<span class="w">  </span><span class="nv">$USE_FP8</span><span class="w"> </span>--bf16<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--optimizer<span class="w"> </span>adam<span class="w"> </span>--adam-beta1<span class="w"> </span><span class="m">0</span>.9<span class="w"> </span>--adam-beta2<span class="w"> </span><span class="m">0</span>.95<span class="w"> </span>--weight-decay<span class="w"> </span><span class="nv">$WEIGHT_DECAY</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grad-clip-norm<span class="w"> </span><span class="nv">$GRAD_CLIP</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># --- å­¦ä¹ ç‡ ---</span>
<span class="w">  </span>--lr<span class="w"> </span><span class="nv">$LR</span><span class="w"> </span>--min-lr<span class="w"> </span><span class="nv">$MIN_LR</span><span class="w"> </span>--lr-decay-style<span class="w"> </span><span class="nv">$LR</span><span class="se">\_</span>DECAY<span class="se">\_</span>STYLE<span class="w"> </span>--lr-warmup-tokens<span class="w"> </span><span class="nv">$LR_WARMUP_TOKENS</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># --- æ•°æ®ä¸IO ---</span>
<span class="w">  </span>--data-path<span class="w"> </span><span class="nv">$DATA_PATH</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--tokenizer-type<span class="w"> </span>GPTSentencePieceTokenizer<span class="w"> </span>--tokenizer-model<span class="w"> </span><span class="nv">$TOKENIZER_PATH</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--data-impl<span class="w"> </span>mmap<span class="w"> </span>--split<span class="w"> </span><span class="m">990</span>,8,2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="se">\</span>
<span class="w">  </span><span class="c1"># --- æ—¥å¿—ä¸ä¿å­˜ ---</span>
<span class="w">  </span>--save<span class="w"> </span><span class="nv">$CHECKPOINT</span><span class="se">\_</span>PATH<span class="w"> </span>--load<span class="w"> </span><span class="nv">$CHECKPOINT_PATH</span><span class="w"> </span>--save-interval<span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--log-interval<span class="w"> </span><span class="m">10</span><span class="w"> </span>--eval-interval<span class="w"> </span><span class="m">100</span><span class="w"> </span>--eval-iters<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--wandb-project<span class="w"> </span><span class="si">${</span><span class="nv">WANDB_PROJECT</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--num-workers<span class="w"> </span><span class="m">2</span><span class="w"> </span>--seed<span class="w"> </span><span class="m">42</span>
</code></pre></div>

<hr />
<h2 id="a4">A.4 ç›‘æ§ä»ªè¡¨ä¸å‘Šè­¦è§„åˆ™</h2>
<h3 id="a41-grafana">A.4.1 Grafana ä»ªè¡¨ç›˜è®¾è®¡ (å…³é”®é¢æ¿)</h3>
<p>ä¸€ä¸ªå¥½çš„ä»ªè¡¨ç›˜åº”æä¾›å…¨å±€æ¦‚è§ˆå’Œä¸‹é’»ç»†èŠ‚çš„èƒ½åŠ›ã€‚</p>
<ol>
<li>
<p><strong>å…¨å±€çŠ¶æ€ (Overview)</strong></p>
<ul>
<li><strong>TFLOPs (Total &amp; Per GPU):</strong> å•å€¼/ä»ªè¡¨ï¼Œæ˜¾ç¤ºå½“å‰é›†ç¾¤æ€»ç®—åŠ›åˆ©ç”¨ç‡ã€‚</li>
<li><strong>Global Batch Loss:</strong> æ—¶é—´åºåˆ—å›¾ï¼Œç›‘æ§æŸå¤±ä¸‹é™è¶‹åŠ¿ã€‚</li>
<li><strong>Active Nodes / GPUs:</strong> çŠ¶æ€é¢æ¿ï¼Œæ˜¾ç¤ºå‚ä¸è®­ç»ƒçš„èŠ‚ç‚¹æ•°ï¼Œå¼‚å¸¸èŠ‚ç‚¹æ ‡çº¢ã€‚</li>
<li><strong>Time to Completion (ETA):</strong> åŸºäºå½“å‰ tokens/sec é¢„ä¼°å‰©ä½™è®­ç»ƒæ—¶é—´ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ€§èƒ½è¯Šæ–­ (Performance Deep-Dive)</strong></p>
<ul>
<li><strong>GPU Utilization Heatmap:</strong> Xè½´ä¸ºæ—¶é—´ï¼ŒYè½´ä¸º Rank IDï¼Œé¢œè‰²æ·±æµ…è¡¨ç¤º GPU åˆ©ç”¨ç‡ã€‚å¿«é€Ÿå®šä½æ‰é˜Ÿæˆ–ç©ºé—²çš„ GPUã€‚</li>
<li><strong>FWD/BWD/OPT Time Breakdown:</strong> å †å æ¡å½¢å›¾ï¼Œæ˜¾ç¤ºå‰å‘ã€åå‘å’Œä¼˜åŒ–å™¨æ›´æ–°çš„è€—æ—¶å æ¯”ã€‚</li>
<li><strong>Data Loader Time:</strong> æ—¶é—´åºåˆ—å›¾ï¼Œç›‘æ§æ•°æ®åŠ è½½æ˜¯å¦æˆä¸ºç“¶é¢ˆã€‚</li>
<li><strong>NVLink/IB Bandwidth:</strong> æ—¶é—´åºåˆ—å›¾ï¼Œç›‘æ§ AllReduceã€AllGather ç­‰é€šä¿¡æ“ä½œçš„å¸¦å®½ã€‚</li>
</ul>
</li>
<li>
<p><strong>MoE ä¸“é¡¹ç›‘æ§ (MoE Dashboard)</strong></p>
<ul>
<li><strong>Expert Utilization Heatmap:</strong> Xè½´ä¸º Layer IDï¼ŒYè½´ä¸º Expert IDï¼Œé¢œè‰²è¡¨ç¤ºè¯¥ä¸“å®¶è¢«è·¯ç”±åˆ°çš„ token ç™¾åˆ†æ¯”ã€‚ç”¨äºå‘ç°â€œæ­»äº¡ä¸“å®¶â€æˆ–è´Ÿè½½çƒ­ç‚¹ã€‚</li>
<li><strong>Load Balancing Loss:</strong> æ—¶é—´åºåˆ—å›¾ï¼Œç›‘æ§ MoE çš„è¾…åŠ©æŸå¤±ã€‚</li>
<li><strong>Router Z-Loss:</strong> æ—¶é—´åºåˆ—å›¾ï¼Œç›‘æ§è·¯ç”± logits çš„æ­£åˆ™åŒ–æŸå¤±ã€‚</li>
<li><strong>Tokens Dropped per Layer:</strong> æ¡å½¢å›¾ï¼Œæ˜¾ç¤ºå› å®¹é‡ä¸è¶³è€Œè¢«ä¸¢å¼ƒçš„ token æ•°é‡ã€‚</li>
</ul>
</li>
</ol>
<h3 id="a42-prometheus-alertsyml">A.4.2 æ‰©å±•çš„ Prometheus å‘Šè­¦è§„åˆ™ (<code>alerts.yml</code>)</h3>
<div class="codehilite"><pre><span></span><code><span class="nt">groups</span><span class="p">:</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">megatron_training_alerts</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># --- CRITICAL (éœ€è¦ç«‹å³å“åº”) ---</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TrainingLossIsNaN</span>
<span class="w">    </span><span class="c1"># ... (åŒå‰)</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GpuEccDoubleBitError</span>
<span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dcgm_ecc_dbe_volatile_total{job=&quot;vla-10b-pretrain&quot;} &gt; 0</span>
<span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1m</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> severity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;critical&quot;</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GPUå‡ºç°åŒæ¯”ç‰¹ECCé”™è¯¯</span><span class="nv"> </span><span class="s">(instance:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}})&quot;</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;èŠ‚ç‚¹</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">çš„</span><span class="nv"> </span><span class="s">GPU</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.gpu</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">å‡ºç°ä¸å¯ä¿®å¤çš„å†…å­˜é”™è¯¯ï¼Œéœ€éš”ç¦»èŠ‚ç‚¹å¹¶æ£€ä¿®ã€‚&quot;</span>

<span class="w">  </span><span class="c1"># --- WARNING (éœ€è¦å…³æ³¨ï¼Œå¯èƒ½å½±å“æ•ˆç‡) ---</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ThroughputDroppedSignificantly</span>
<span class="w">    </span><span class="c1"># ... (åŒå‰ï¼Œé˜ˆå€¼å¯è®¾ä¸ºæ›´æ„Ÿçš„ 0.85)</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GradientNormExplosion</span>
<span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">megatron_grad_norm{job=&quot;vla-10b-pretrain&quot;} &gt; 100.0</span>
<span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> severity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;æ¢¯åº¦èŒƒæ•°çˆ†ç‚¸</span><span class="nv"> </span><span class="s">(job:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.job</span><span class="nv"> </span><span class="s">}})&quot;</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;æ¨¡å‹</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.job</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">çš„æ¢¯åº¦èŒƒæ•°æŒç»­é«˜äº</span><span class="nv"> </span><span class="s">100.0ï¼Œå¯èƒ½å¯¼è‡´è®­ç»ƒä¸ç¨³å®šã€‚&quot;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DeadMoeExpert</span>
<span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate(megatron_moe_routed_tokens_per_expert{job=&quot;vla-10b-pretrain&quot;}[15m]) == 0</span>
<span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30m</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> severity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warning&quot;</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;æ£€æµ‹åˆ°æ­»äº¡çš„MoEä¸“å®¶</span><span class="nv"> </span><span class="s">(layer:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.layer</span><span class="nv"> </span><span class="s">}},</span><span class="nv"> </span><span class="s">expert:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.expert</span><span class="nv"> </span><span class="s">}})&quot;</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ä¸“å®¶</span><span class="nv"> </span><span class="s">({{</span><span class="nv"> </span><span class="s">$labels.layer</span><span class="nv"> </span><span class="s">}},</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.expert</span><span class="nv"> </span><span class="s">}})</span><span class="nv"> </span><span class="s">åœ¨è¿‡å»30åˆ†é’Ÿå†…æ²¡æœ‰è¢«è·¯ç”±åˆ°ä»»ä½•</span><span class="nv"> </span><span class="s">tokenã€‚&quot;</span>

<span class="w">  </span><span class="c1"># --- INFO (çŠ¶æ€é€šçŸ¥) ---</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LearningRateAnnealingStarted</span>
<span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">megatron_lr{job=&quot;vla-10b-pretrain&quot;} &lt; 1.0e-4</span><span class="w"> </span><span class="c1"># å‡è®¾è¿™æ˜¯åˆå§‹LR</span>
<span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1m</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> severity</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;info&quot;</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;å­¦ä¹ ç‡å·²å¼€å§‹é€€ç«</span><span class="nv"> </span><span class="s">(job:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.job</span><span class="nv"> </span><span class="s">}})&quot;</span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;è®­ç»ƒå·²è¿‡</span><span class="nv"> </span><span class="s">warmup</span><span class="nv"> </span><span class="s">é˜¶æ®µï¼Œå­¦ä¹ ç‡è°ƒåº¦å™¨å¼€å§‹å·¥ä½œã€‚&quot;</span>
</code></pre></div>

<hr />
<h2 id="a5">A.5 è¯„æµ‹æ¸…å•ä¸æ‰“åˆ†æ±‡æ€»è¡¨æ¨¡æ¿</h2>
<p>è¿™å¼ è¡¨æ›´ä¸ºè¯¦å°½ï¼ŒåŠ å…¥äº†è¿è¡Œé…ç½®å’Œé¢„æœŸè€—æ—¶ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªå¯æ‰§è¡Œçš„è¯„æµ‹è®¡åˆ’ã€‚</p>
<p>| ç»´åº¦ | è¯„æµ‹é›† | æŒ‡æ ‡ | 1B Dense | 10B MoE | SOTA å‚è€ƒ | è¯„æµ‹é…ç½®/å‘½ä»¤ | é¢„æœŸè€—æ—¶ (A100x8) |</p>
<table>
<thead>
<tr>
<th style="text-align: left;">ç»´åº¦</th>
<th style="text-align: left;">è¯„æµ‹é›†</th>
<th style="text-align: left;">æŒ‡æ ‡</th>
<th style="text-align: left;">1B Dense</th>
<th style="text-align: left;">10B MoE</th>
<th style="text-align: left;">SOTA å‚è€ƒ</th>
<th style="text-align: left;">è¯„æµ‹é…ç½®/å‘½ä»¤</th>
<th style="text-align: left;">é¢„æœŸè€—æ—¶ (A100x8)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>æ–‡æœ¬-ç†è§£</strong></td>
<td style="text-align: left;">MMLU</td>
<td style="text-align: left;">Acc</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">89.7 (GPT-4)</td>
<td style="text-align: left;"><code>lm-eval --model ... --tasks mmlu --num_fewshot 5</code></td>
<td style="text-align: left;">4 hours</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">C-Eval</td>
<td style="text-align: left;">Acc</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">90.2 (GPT-4)</td>
<td style="text-align: left;"><code>lm-eval --tasks ceval_... --num_fewshot 5</code></td>
<td style="text-align: left;">3 hours</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ–‡æœ¬-ä»£ç </strong></td>
<td style="text-align: left;">HumanEval</td>
<td style="text-align: left;">Pass@1</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">92.0 (AlphaCode2)</td>
<td style="text-align: left;"><code>lm-eval --tasks humaneval --batch_size 1</code></td>
<td style="text-align: left;">6 hours</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ–‡æœ¬-é•¿ä¸Šä¸‹æ–‡</strong></td>
<td style="text-align: left;">Needle In A Haystack</td>
<td style="text-align: left;">Score</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">99%+</td>
<td style="text-align: left;"><code>run_niah.py --ctx_len 32768 --depths 10</code></td>
<td style="text-align: left;">2 hours</td>
</tr>
<tr>
<td style="text-align: left;"><strong>éŸ³é¢‘-ASR</strong></td>
<td style="text-align: left;">AISHELL-1 (Zh)</td>
<td style="text-align: left;">CER</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">4.1 (Whisper-L)</td>
<td style="text-align: left;"><code>asr_eval.py --dataset aishell1</code></td>
<td style="text-align: left;">1 hour</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">LibriSpeech (En)</td>
<td style="text-align: left;">WER</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">2.5 (Whisper-L)</td>
<td style="text-align: left;"><code>asr_eval.py --dataset librispeech --split test-clean</code></td>
<td style="text-align: left;">2 hours</td>
</tr>
<tr>
<td style="text-align: left;"><strong>å›¾åƒ-ç†è§£</strong></td>
<td style="text-align: left;">MMBench</td>
<td style="text-align: left;">Acc</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">78.3 (Qwen-VL-Max)</td>
<td style="text-align: left;"><code>mm_eval.py --dataset mmbench_test_en</code></td>
<td style="text-align: left;">1.5 hours</td>
</tr>
<tr>
<td style="text-align: left;"><strong>è§†é¢‘-ç†è§£</strong></td>
<td style="text-align: left;">VATEX (En/Zh)</td>
<td style="text-align: left;">CIDEr</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">80.1 (LLaMA-VID)</td>
<td style="text-align: left;"><code>video_eval.py --dataset vatex --task zh_captions</code></td>
<td style="text-align: left;">5 hours</td>
</tr>
<tr>
<td style="text-align: left;"><strong>3D-ç†è§£</strong></td>
<td style="text-align: left;">Procedural QA</td>
<td style="text-align: left;">EM</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">-</td>
<td style="text-align: left;"><code>3d_eval.py --task blender_script_qa</code></td>
<td style="text-align: left;">0.5 hours</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VLA-å…·èº«</strong></td>
<td style="text-align: left;">CALVIN</td>
<td style="text-align: left;">Success Rate</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">34% (RT-2)</td>
<td style="text-align: left;"><code>calvin_eval.py --checkpoint ...</code></td>
<td style="text-align: left;">24 hours</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VLA-è‡ªåŠ¨é©¾é©¶</strong></td>
<td style="text-align: left;">nuScenes (Open-loop)</td>
<td style="text-align: left;">mAP/NDS</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">75.8 (UniAD)</td>
<td style="text-align: left;"><code>nuscenes_eval.py --task detection</code></td>
<td style="text-align: left;">8 hours</td>
</tr>
<tr>
<td style="text-align: left;"><strong>å®‰å…¨ä¸å¯¹é½</strong></td>
<td style="text-align: left;">SafetyBench</td>
<td style="text-align: left;">Score</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">95.2 (Claude 2)</td>
<td style="text-align: left;"><code>safety_eval.py --suite full</code></td>
<td style="text-align: left;">4 hours</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">TruthfulQA</td>
<td style="text-align: left;">% Truthful</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">60.0 (GPT-4)</td>
<td style="text-align: left;"><code>lm-eval --tasks truthfulqa_mc</code></td>
<td style="text-align: left;">1 hour</td>
</tr>
</tbody>
</table>
            </article>
            
            <nav class="page-nav"><a href="chapter27.html" class="nav-link prev">â† `[chapter27.md]` å¸¸è§é™·é˜±ä¸æ•…éšœæ’æŸ¥</a><a href="appendixA.html" class="nav-link next">é™„å½• Aï¼šé…ç½®ä¸è„šæœ¬æ¨¡æ¿ï¼ˆå¯å¤åˆ¶ï¼‰ â†’</a></nav>
        </main>
    </div>
</body>
</html>